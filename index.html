<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soldier Exposure Tracker - Command Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom Scrollbar for a clean military look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e5e5e5;
        }
        ::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #333;
        }

        /* Chart Container Strict Styling per requirements */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px; 
            height: 350px;    
            max-height: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        
        @media (max-width: 640px) {
            .chart-container {
                height: 250px;
            }
        }

        /* Utility for status pulses */
        .status-dot {
            height: 10px;
            width: 10px;
            border-radius: 50%;
            display: inline-block;
        }
        .animate-pulse-fast {
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }

        /* Modal styling */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            max-width: 80vw;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body class="bg-[#f2f0e9] text-gray-800 font-sans leading-normal tracking-normal selection:bg-gray-300">

    <!-- Chosen Palette: Warm Neutrals (Sand/Desert) with Military Dark Grey and Semantic Alerts (Red/Amber/Green) -->
    <!-- Application Structure Plan: 
         The app is designed as a "Command Center Dashboard" to reflect the user persona (Commander/Mission Lead).
         1. Header: Quick status and navigation.
         2. Context Briefing: Explains the "Why" (Source: Slide 2 & 3) using a clean text section.
         3. Live Operations Dashboard: The core interactive area. 
            - Simulation Control: Allows user to "Start Mission" (generating data like the Python script).
            - Real-time Metrics: Cards showing instantaneous data.
            - Visualizations: 
              - Line Chart: Tracks SRS (Soldier Risk Score) over time (Source: Slide 5 & 8).
              - Radar Chart: Compares current environmental factors (PM2.5, CO2, etc.) against thresholds.
         4. Squad Roster: Interactive list of "soldiers". Clicking a soldier filters the dashboard to show their specific telemetry (Interaction).
         5. Architecture Logic: A step-by-step interactive flow explaining how the system works (Source: Slide 6 & 7).
         
         This structure moves from "Context" -> "Live Action" -> "Deep Dive Analysis", prioritizing the real-time monitoring aspect highlighted in the report.
    -->
    
    <!-- Visualization & Content Choices:
         1. Global Status Bar (Top): Goal: Inform. Method: Fixed header. Justification: Constant visibility of mission status.
         2. SRS Trend (Line Chart): Goal: Change. Method: Chart.js Line chart. Interaction: Live updates every second. Justification: Shows how risk evolves, critical for "Early Detection" (Slide 3).
         3. Hazard Radar (Radar Chart): Goal: Compare. Method: Chart.js Radar. Interaction: Updates with soldier selection. Justification: Shows which specific factor (Heat vs Gas) is the primary threat.
         4. Roster Table: Goal: Organize. Method: Tailwind Grid/Table + JS Selection. Justification: Allows drilling down from aggregate view to individual soldier view.
         5. Architecture Steps: Goal: Explain process. Method: Clickable card flow. Justification: Simplifies the Slide 6/7 diagrams into an interactive learning sequence.
         CONFIRMATION: NO SVG graphics used. NO Mermaid JS used.
    -->

    <!-- Navigation / Header -->
    <nav class="bg-[#2d3748] p-4 sticky top-0 z-50 shadow-lg">
        <div class="container mx-auto flex flex-wrap items-center justify-between">
            <div class="flex items-center flex-shrink-0 text-white mr-6">
                <span class="text-2xl tracking-tight mr-2">üõ°Ô∏è</span>
                <span class="font-bold text-xl uppercase tracking-widest">Soldier Exposure Tracker</span>
            </div>
            <div class="block lg:hidden">
                <button id="nav-toggle" class="flex items-center px-3 py-2 border rounded text-gray-300 border-gray-400 hover:text-white hover:border-white">
                    ‚ò∞
                </button>
            </div>
            <div id="nav-content" class="w-full block flex-grow lg:flex lg:items-center lg:w-auto hidden lg:block pt-6 lg:pt-0">
                <div class="text-sm lg:flex-grow flex justify-end">
                    <a href="#mission-brief" class="block mt-4 lg:inline-block lg:mt-0 text-gray-300 hover:text-white mr-8 font-semibold">Mission Brief</a>
                    <a href="#live-ops" class="block mt-4 lg:inline-block lg:mt-0 text-gray-300 hover:text-white mr-8 font-semibold">Live Ops</a>
                    <a href="#squad-status" class="block mt-4 lg:inline-block lg:mt-0 text-gray-300 hover:text-white mr-8 font-semibold">Squad Status</a>
                    <a href="#system-arch" class="block mt-4 lg:inline-block lg:mt-0 text-gray-300 hover:text-white font-semibold">System Arch</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <main class="container mx-auto px-4 py-8">

        <!-- SECTION 1: Mission Brief (Context) -->
        <section id="mission-brief" class="mb-12 bg-white rounded-lg shadow-md border-l-4 border-yellow-600 p-6">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4 border-b pb-2">Mission Briefing</h2>
                    <p class="text-gray-700 mb-4 text-lg">
                        Modern warfare presents an <strong>Invisible Enemy</strong>: environmental hazards. Soldiers in desert operations, high-altitude patrols, and conflict zones face extreme heat, toxic gases, and particulate matter.
                    </p>
                    <p class="text-gray-600 mb-4">
                        Current manual reporting leads to a "Visibility Gap." The <strong>Soldier Exposure Tracker</strong> bridges this gap by merging:
                    </p>
                    <ul class="list-none space-y-2 mb-6 text-gray-700">
                        <li>üì° <strong>Satellite Intelligence:</strong> Terrain & Weather hazards.</li>
                        <li>‚åö <strong>Wearable Sensors:</strong> Real-time physiological & local environment data.</li>
                        <li>üß† <strong>AI Prediction:</strong> Proactive calculation of the Soldier Risk Score (SRS).</li>
                    </ul>
                    <div class="bg-gray-100 p-4 rounded text-sm text-gray-600 italic border border-gray-300">
                        "Early detection is the only defense. This system shifts from reactive casualty management to proactive predictive safety."
                    </div>
                </div>
                <div class="flex flex-col justify-center space-y-4">
                    <div class="bg-red-50 border border-red-200 p-4 rounded shadow-sm">
                        <h3 class="font-bold text-red-800 text-lg mb-1">üö® Critical Threats</h3>
                        <ul class="text-sm text-red-700 space-y-1">
                            <li>‚Ä¢ Heatstroke & Dehydration</li>
                            <li>‚Ä¢ PM2.5 Dust Overload</li>
                            <li>‚Ä¢ Toxic Gas (VOCs)</li>
                            <li>‚Ä¢ Hypoxia (Altitude)</li>
                        </ul>
                    </div>
                    <div class="bg-green-50 border border-green-200 p-4 rounded shadow-sm">
                        <h3 class="font-bold text-green-800 text-lg mb-1">‚úÖ System Goals</h3>
                        <ul class="text-sm text-green-700 space-y-1">
                            <li>‚Ä¢ Maximize Survivability</li>
                            <li>‚Ä¢ Real-time Command Visibility</li>
                            <li>‚Ä¢ Offline Military Mode</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION 2: Live Operations Dashboard (The "Simulated" App) -->
        <section id="live-ops" class="mb-12">
            <div class="flex flex-col md:flex-row justify-between items-end mb-6 border-b border-gray-300 pb-2">
                <div class="max-w-3xl">
                    <h2 class="text-3xl font-bold text-gray-800">Command Center Dashboard</h2>
                    <p class="text-gray-600 mt-2">
                        Real-time telemetry feed from deployed units. This dashboard aggregates sensor data (PM2.5, CO2, Temp) and Satellite Indices to calculate the live <strong>Soldier Risk Score (SRS)</strong>. Use the controls to simulate mission progression.
                    </p>
                </div>
                <div class="mt-4 md:mt-0 flex space-x-4">
                    <button id="toggle-sim-btn" class="bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-6 rounded shadow-lg transition transform hover:-translate-y-1 flex items-center">
                        <span id="sim-icon" class="mr-2">‚ñ∂Ô∏è</span> <span id="sim-text">START MISSION SIMULATION</span>
                    </button>
                    <button id="debrief-btn" class="bg-gray-800 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded shadow-lg transition transform hover:-translate-y-1 flex items-center" disabled>
                        Generate Debrief Report ‚ú®
                    </button>
                </div>
            </div>

            <!-- Metrics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Card 1 -->
                <div class="bg-white rounded p-4 shadow border-t-4 border-blue-500">
                    <div class="text-gray-500 text-xs font-bold uppercase tracking-wider">Monitored Unit</div>
                    <div class="text-2xl font-bold text-gray-800 mt-1">Bravo Team</div>
                    <div class="text-sm text-green-600 mt-2">‚óè 5 Sensors Active</div>
                </div>
                <!-- Card 2 -->
                <div class="bg-white rounded p-4 shadow border-t-4 border-gray-800">
                    <div class="text-gray-500 text-xs font-bold uppercase tracking-wider">Avg. Risk Score (SRS)</div>
                    <div class="text-3xl font-bold text-gray-800 mt-1" id="avg-srs-display">--</div>
                    <div class="text-xs text-gray-500 mt-1">Scale: 0 (Safe) - 100 (Critical)</div>
                </div>
                <!-- Card 3 -->
                <div class="bg-white rounded p-4 shadow border-t-4 border-orange-500">
                    <div class="text-gray-500 text-xs font-bold uppercase tracking-wider">Environment Status</div>
                    <div class="text-2xl font-bold text-gray-800 mt-1" id="env-status-display">Calibrating...</div>
                    <div class="text-sm text-gray-500 mt-2" id="temp-display">Temp: --¬∞C</div>
                </div>
                <!-- Card 4 -->
                <div class="bg-white rounded p-4 shadow border-t-4 border-red-600">
                    <div class="text-gray-500 text-xs font-bold uppercase tracking-wider">Active Alerts</div>
                    <div class="text-2xl font-bold text-red-600 mt-1" id="alert-count-display">0</div>
                    <div class="text-xs text-red-500 mt-1 font-semibold animate-pulse-fast" id="alert-msg">System Nominal</div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                
                <!-- Chart 1: SRS Trend -->
                <div class="bg-white p-4 rounded shadow-md flex flex-col">
                    <h3 class="font-bold text-gray-700 mb-2">SRS (Risk Score) Timeline - Live Feed</h3>
                    <p class="text-xs text-gray-500 mb-4">Tracks the aggregate risk exposure over mission time. Spikes indicate hazardous zones.</p>
                    <div class="flex-grow flex items-center justify-center bg-gray-50 rounded border border-gray-100 p-2">
                        <!-- Chart Container -->
                        <div class="chart-container">
                            <canvas id="srsLineChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Chart 2: Hazard Radar -->
                <div class="bg-white p-4 rounded shadow-md flex flex-col">
                    <h3 class="font-bold text-gray-700 mb-2">Current Hazard Composition</h3>
                    <p class="text-xs text-gray-500 mb-4">Breakdown of contributing factors to the current risk score.</p>
                    <div class="flex-grow flex items-center justify-center bg-gray-50 rounded border border-gray-100 p-2">
                        <!-- Chart Container -->
                        <div class="chart-container">
                            <canvas id="hazardRadarChart"></canvas>
                        </div>
                    </div>
                </div>

            </div>
        </section>

        <!-- SECTION 3: Squad Status (Interactive Roster) -->
        <section id="squad-status" class="mb-12">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b border-gray-300 pb-2">Unit Telemetry Roster</h2>
            <p class="text-gray-600 mb-6">
                Detailed breakdown of each soldier's status. The AI module processes individual inputs (Activity Level + Local PM2.5 + Body Temp) to output a personalized Risk Score. 
                <br><strong>Interact:</strong> Click a row to focus the dashboard charts on that specific soldier.
            </p>

            <div class="bg-white shadow rounded-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full leading-normal">
                        <thead>
                            <tr class="bg-gray-800 text-white text-left text-xs font-semibold uppercase tracking-wider">
                                <th class="px-5 py-3">Soldier ID</th>
                                <th class="px-5 py-3">Status</th>
                                <th class="px-5 py-3">Activity</th>
                                <th class="px-5 py-3">PM2.5 (¬µg/m¬≥)</th>
                                <th class="px-5 py-3">CO2 (ppm)</th>
                                <th class="px-5 py-3">Body Temp</th>
                                <th class="px-5 py-3 text-right">SRS (Risk)</th>
                            </tr>
                        </thead>
                        <tbody id="roster-body">
                            <!-- JS will populate rows here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- SECTION 4: System Architecture (Explainer) -->
        <section id="system-arch" class="mb-12 bg-gray-100 rounded-lg p-8 border border-gray-300">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">System Architecture & Logic Flow</h2>
            <p class="text-center text-gray-600 max-w-2xl mx-auto mb-10">
                How the Soldier Exposure Tracker converts raw data into life-saving alerts. Click any step to learn more about the data processing.
            </p>

            <!-- Flow Diagram (CSS Grid/Flex) -->
            <div class="flex flex-col md:flex-row justify-between items-stretch gap-4 relative">
                <!-- Connecting Line (Desktop) -->
                <div class="hidden md:block absolute top-1/2 left-0 w-full h-1 bg-gray-300 -z-0 transform -translate-y-1/2"></div>

                <!-- Step 1 -->
                <div class="arch-step flex-1 bg-white p-6 rounded shadow cursor-pointer relative z-10 transition hover:shadow-xl hover:-translate-y-1 border-b-4 border-blue-500" onclick="showArchDetail('sensors')">
                    <div class="text-4xl mb-2 text-center">‚åö</div>
                    <h3 class="font-bold text-center text-gray-800">1. Data Collection</h3>
                    <p class="text-xs text-center text-gray-500 mt-2">Wearable Sensors + Satellite API</p>
                </div>

                <!-- Step 2 -->
                <div class="arch-step flex-1 bg-white p-6 rounded shadow cursor-pointer relative z-10 transition hover:shadow-xl hover:-translate-y-1 border-b-4 border-yellow-500" onclick="showArchDetail('fusion')">
                    <div class="text-4xl mb-2 text-center">üì±</div>
                    <h3 class="font-bold text-center text-gray-800">2. Edge Processing</h3>
                    <p class="text-xs text-center text-gray-500 mt-2">Mobile App Data Fusion</p>
                </div>

                <!-- Step 3 -->
                <div class="arch-step flex-1 bg-white p-6 rounded shadow cursor-pointer relative z-10 transition hover:shadow-xl hover:-translate-y-1 border-b-4 border-purple-500" onclick="showArchDetail('ai')">
                    <div class="text-4xl mb-2 text-center">üß†</div>
                    <h3 class="font-bold text-center text-gray-800">3. AI Analysis</h3>
                    <p class="text-xs text-center text-gray-500 mt-2">Predictive Risk Modeling</p>
                </div>

                <!-- Step 4 -->
                <div class="arch-step flex-1 bg-white p-6 rounded shadow cursor-pointer relative z-10 transition hover:shadow-xl hover:-translate-y-1 border-b-4 border-red-500" onclick="showArchDetail('alert')">
                    <div class="text-4xl mb-2 text-center">üì°</div>
                    <h3 class="font-bold text-center text-gray-800">4. Action</h3>
                    <p class="text-xs text-center text-gray-500 mt-2">Command Alerts & Evac</p>
                </div>
            </div>

            <!-- Detail Box -->
            <div id="arch-detail-box" class="mt-8 bg-white p-6 rounded border-l-4 border-gray-800 hidden animate-fade-in">
                <h4 id="detail-title" class="text-xl font-bold text-gray-800 mb-2">Select a step above...</h4>
                <p id="detail-content" class="text-gray-600">Details will appear here.</p>
            </div>
        </section>

        <!-- Footer -->
        <footer class="text-center text-gray-500 text-sm py-8 border-t border-gray-300">
            <p>&copy; 2025 Soldier Exposure Tracker Project. Military Safety Systems.</p>
            <p class="mt-1">Concept by n.s.sahana and bavanthika</p>
        </footer>

    </main>

    <!-- Debrief Modal -->
    <div id="debrief-modal" class="modal">
        <div class="modal-content w-full md:w-2/3">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-2xl font-bold text-gray-800">Mission Debrief Report</h3>
                <button onclick="document.getElementById('debrief-modal').style.display = 'none'" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <div id="debrief-output" class="text-gray-700 space-y-4">
                <div id="debrief-loading" class="text-center text-lg text-blue-600">
                    Analyzing historical data and generating report...
                </div>
                <div id="debrief-result" class="hidden"></div>
            </div>
        </div>
    </div>


    <!-- Logic Script -->
    <script>
        // --- GEMINI API SETUP ---
        const API_KEY = ""; // Canvas will provide this
        const TEXT_MODEL = 'gemini-2.5-flash-preview-09-2025';
        const TTS_MODEL = 'gemini-2.5-flash-preview-tts';

        // --- UTILITIES FOR API AND TTS ---

        /** Utility to perform fetch with exponential backoff */
        async function fetchWithBackoff(url, options, maxRetries = 5) {
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    } else if (response.status === 429 && attempt < maxRetries - 1) {
                        const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    } else {
                        throw new Error(`API request failed with status ${response.status}: ${response.statusText}`);
                    }
                } catch (error) {
                    if (attempt === maxRetries - 1) {
                        console.error("Fetch failed after multiple retries:", error);
                        throw error;
                    }
                    const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        /** Converts base64 PCM audio to ArrayBuffer. */
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        /** Converts PCM audio data to a playable WAV Blob. */
        function pcmToWav(pcm16, sampleRate = 24000) {
            const numChannels = 1;
            const bytesPerSample = 2; // Int16
            const buffer = new ArrayBuffer(44 + pcm16.length * bytesPerSample);
            const view = new DataView(buffer);

            /* RIFF identifier */
            view.setUint32(0, 0x52494646, false); // "RIFF"
            /* file length */
            view.setUint32(4, 36 + pcm16.length * bytesPerSample, true);
            /* RIFF type */
            view.setUint32(8, 0x57415645, false); // "WAVE"
            /* format chunk identifier */
            view.setUint32(12, 0x666d7420, false); // "fmt "
            /* format chunk length */
            view.setUint32(16, 16, true);
            /* sample format (1 for PCM) */
            view.setUint16(20, 1, true);
            /* channel count */
            view.setUint16(22, numChannels, true);
            /* sample rate */
            view.setUint32(24, sampleRate, true);
            /* byte rate (sampleRate * numChannels * bytesPerSample) */
            view.setUint32(28, sampleRate * numChannels * bytesPerSample, true);
            /* block align (numChannels * bytesPerSample) */
            view.setUint16(32, numChannels * bytesPerSample, true);
            /* bits per sample */
            view.setUint16(34, 16, true);
            /* data chunk identifier */
            view.setUint32(36, 0x64617461, false); // "data"
            /* data chunk length */
            view.setUint32(40, pcm16.length * bytesPerSample, true);

            // Write PCM data
            let offset = 44;
            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(offset, pcm16[i], true);
                offset += 2;
            }

            return new Blob([view], { type: 'audio/wav' });
        }


        // --- GEMINI TTS ALERT CALL ---

        let isAlerting = false;
        async function announceCriticalAlert(srsScore) {
            if (isAlerting) return;
            isAlerting = true;
            
            const message = `Critical Alert! Soldier Risk Score is ${srsScore}. Repeat: Critical Alert! Immediate Evacuation Required.`;
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${TTS_MODEL}:generateContent?key=${API_KEY}`;
            
            const payload = {
                contents: [{
                    parts: [{ text: `Say in a firm, urgent tone: ${message}` }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Kore" } // Firm voice
                        }
                    }
                },
                model: TTS_MODEL
            };

            try {
                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 24000;
                    
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    const audio = new Audio(audioUrl);
                    audio.play();

                    audio.onended = () => {
                        isAlerting = false;
                        URL.revokeObjectURL(audioUrl);
                    };

                } else {
                    console.error("TTS failed or returned unexpected format.", result);
                    isAlerting = false;
                }
            } catch (error) {
                console.error("Error announcing alert:", error);
                isAlerting = false;
            }
        }


        // --- GEMINI LLM DEBRIEF CALL ---

        async function generateDebriefReport() {
            const debriefBtn = document.getElementById('debrief-btn');
            const debriefLoading = document.getElementById('debrief-loading');
            const debriefResult = document.getElementById('debrief-result');
            
            debriefLoading.classList.remove('hidden');
            debriefResult.classList.add('hidden');
            debriefResult.innerHTML = '';
            debriefBtn.disabled = true;

            document.getElementById('debrief-modal').style.display = 'flex';

            // 1. Summarize historical data
            const maxSRS = Math.max(...historicalSRS.data);
            const totalDuration = historicalSRS.labels.length * 1.5; // 1.5s per step
            const totalSteps = historicalSRS.data.length;
            const avgSRS = historicalSRS.data.reduce((a, b) => a + b, 0) / totalSteps;
            const dangerSpikes = historicalSRS.data.filter(s => s > 70).length;

            const dataSummary = `Mission Duration: ${totalDuration.toFixed(0)} seconds (${totalSteps} steps). Highest SRS Reached: ${maxSRS}. Average SRS: ${avgSRS.toFixed(1)}. Critical Spikes (SRS > 70): ${dangerSpikes}. Most soldiers were S-Bravo (Run) and S-Echo (Combat). Environmental conditions included high PM2.5 and rising temperatures.`;
            
            const systemPrompt = "Act as a military operations analyst. Write a concise, professional, single-paragraph after-action report (AAR) summarizing the environmental risks and risk mitigation needs based ONLY on the provided data. Use formal, technical language.";
            const userQuery = `Generate an after-action report based on the following simulation data summary: ${dataSummary}`;

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${API_KEY}`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Error generating report.";

                debriefResult.innerHTML = `<p>${text}</p>`;
            } catch (error) {
                debriefResult.innerHTML = `<p class="text-red-500">Error generating report. API or network issue.</p>`;
                console.error("LLM Debrief Error:", error);
            } finally {
                debriefLoading.classList.add('hidden');
                debriefResult.classList.remove('hidden');
                debriefBtn.disabled = false;
            }
        }


        // --- MAIN APPLICATION LOGIC ---

        // State Management
        let isSimulating = false;
        let simInterval = null;
        let timeStep = 0;
        let selectedSoldierId = null; // null means Aggregate View

        // Base Data Structure
        const soldiers = [
            { id: 'S-Alpha', name: 'Sgt. J. Doe', activity: 'Walk', baseTemp: 37.0, basePM: 50, baseCO2: 450 },
            { id: 'S-Bravo', name: 'Pvt. A. Smith', activity: 'Run', baseTemp: 37.5, basePM: 120, baseCO2: 800 },
            { id: 'S-Charlie', name: 'Cpl. B. Wayne', activity: 'Rest', baseTemp: 36.8, basePM: 40, baseCO2: 420 },
            { id: 'S-Delta', name: 'Sgt. K. Curry', activity: 'Walk', baseTemp: 37.1, basePM: 60, baseCO2: 500 },
            { id: 'S-Echo', name: 'Pvt. M. Lewis', activity: 'Combat', baseTemp: 38.0, basePM: 180, baseCO2: 1200 }
        ];

        // Live Data Storage
        let liveData = [];
        let historicalSRS = {
            labels: [],
            data: []
        };

        // DOM Elements
        const toggleBtn = document.getElementById('toggle-sim-btn');
        const debriefBtn = document.getElementById('debrief-btn');
        const simIcon = document.getElementById('sim-icon');
        const simText = document.getElementById('sim-text');
        const avgSrsDisplay = document.getElementById('avg-srs-display');
        const envStatusDisplay = document.getElementById('env-status-display');
        const tempDisplay = document.getElementById('temp-display');
        const alertCountDisplay = document.getElementById('alert-count-display');
        const alertMsg = document.getElementById('alert-msg');
        const rosterBody = document.getElementById('roster-body');

        // --- CHART INITIALIZATION ---
        
        // 1. Line Chart (SRS Trend)
        const ctxLine = document.getElementById('srsLineChart').getContext('2d');
        const srsChart = new Chart(ctxLine, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Risk Score (SRS)',
                    data: [],
                    borderColor: '#C53030', // Red
                    backgroundColor: 'rgba(197, 48, 48, 0.1)',
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true,
                    pointRadius: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: { duration: 500 },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: { display: true, text: 'Risk Score (0-100)' }
                    },
                    x: {
                        title: { display: true, text: 'Mission Time (s)' }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });

        // 2. Radar Chart (Hazards)
        const ctxRadar = document.getElementById('hazardRadarChart').getContext('2d');
        const radarChart = new Chart(ctxRadar, {
            type: 'radar',
            data: {
                labels: ['Thermal (Temp)', 'Air Quality (PM2.5)', 'Toxicity (VOC)', 'Suffocation (CO2)', 'Fatigue'],
                datasets: [{
                    label: 'Current Hazard Level',
                    data: [20, 20, 20, 20, 20],
                    fill: true,
                    backgroundColor: 'rgba(214, 158, 46, 0.4)', // Amber
                    borderColor: '#D69E2E',
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#D69E2E',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: '#D69E2E'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        angleLines: { display: true },
                        suggestedMin: 0,
                        suggestedMax: 100
                    }
                }
            }
        });


        // --- LOGIC FUNCTIONS ---

        function calculateSRS(temp, pm25, co2, activity) {
            // Mock AI Calculation Logic
            let tempRisk = (temp - 30) * 4; 
            if(tempRisk < 0) tempRisk = 0;
            
            let pmRisk = pm25 / 4; 
            
            let co2Risk = (co2 - 400) / 30; 
            
            let activityMultiplier = 1.0;
            if(activity === 'Run') activityMultiplier = 1.2;
            if(activity === 'Combat') activityMultiplier = 1.5;

            let rawScore = (tempRisk + pmRisk + co2Risk) * activityMultiplier / 2.5;
            
            return Math.min(Math.round(rawScore), 100);
        }

        function generateDataStep() {
            timeStep++;
            let stepData = [];
            let totalSRS = 0;
            let totalTemp = 0;
            let highRiskCount = 0;

            // Generate data for each soldier
            soldiers.forEach(soldier => {
                let currentTemp = soldier.baseTemp + (Math.random() - 0.5) + (timeStep * 0.05); 
                if(currentTemp > 42) currentTemp = 42; 
                
                let currentPM = soldier.basePM + (Math.random() * 20); 
                let currentCO2 = soldier.baseCO2 + (Math.random() * 50);

                // Calculate Risk
                let srs = calculateSRS(currentTemp, currentPM, currentCO2, soldier.activity);
                
                if (srs > 60) highRiskCount++;

                stepData.push({
                    id: soldier.id,
                    name: soldier.name,
                    activity: soldier.activity,
                    temp: currentTemp.toFixed(1),
                    pm: Math.round(currentPM),
                    co2: Math.round(currentCO2),
                    srs: srs
                });

                totalSRS += srs;
                totalTemp += currentTemp;
            });

            liveData = stepData; 

            // Update UI based on Selection
            updateDashboard(highRiskCount, totalSRS / soldiers.length, totalTemp / soldiers.length);
        }

        function updateDashboard(alertCount, avgSRS, avgTemp) {
            
            let displayData = {};
            if (selectedSoldierId) {
                const soldierData = liveData.find(s => s.id === selectedSoldierId);
                displayData = {
                    srs: soldierData.srs,
                    temp: parseFloat(soldierData.temp),
                    pm: soldierData.pm,
                    co2: soldierData.co2
                };
                document.querySelector('.text-gray-500.tracking-wider').innerText = `DATA: ${soldierData.name}`; 
            } else {
                displayData = {
                    srs: Math.round(avgSRS),
                    temp: avgTemp,
                    pm: liveData.reduce((acc, curr) => acc + curr.pm, 0) / liveData.length,
                    co2: liveData.reduce((acc, curr) => acc + curr.co2, 0) / liveData.length
                };
                document.querySelector('.text-gray-500.tracking-wider').innerText = `MONITORED UNIT: BRAVO TEAM`;
            }

            // Update Cards
            avgSrsDisplay.innerText = displayData.srs;
            
            let currentSrsColorClass = "";
            if(displayData.srs < 40) currentSrsColorClass = "text-green-600";
            else if(displayData.srs < 70) currentSrsColorClass = "text-yellow-600";
            else currentSrsColorClass = "text-red-600 animate-pulse";
            
            avgSrsDisplay.className = `text-3xl font-bold mt-1 ${currentSrsColorClass}`;


            tempDisplay.innerText = `Temp: ${displayData.temp.toFixed(1)}¬∞C`;
            
            if(displayData.srs > 75) {
                envStatusDisplay.innerText = "CRITICAL";
                envStatusDisplay.className = "text-2xl font-bold text-red-600 mt-1";
                if (isSimulating) announceCriticalAlert(displayData.srs); // TTS CALL
            } else if (displayData.srs > 45) {
                envStatusDisplay.innerText = "ELEVATED";
                envStatusDisplay.className = "text-2xl font-bold text-yellow-600 mt-1";
            } else {
                envStatusDisplay.innerText = "NOMINAL";
                envStatusDisplay.className = "text-2xl font-bold text-green-600 mt-1";
            }

            alertCountDisplay.innerText = alertCount;
            alertMsg.innerText = alertCount > 0 ? "CHECK ROSTER" : "System Nominal";

            // Update Charts
            if (historicalSRS.labels.length > 20) {
                historicalSRS.labels.shift();
                historicalSRS.data.shift();
            }
            historicalSRS.labels.push(timeStep + 's');
            historicalSRS.data.push(displayData.srs);

            srsChart.data.labels = historicalSRS.labels;
            srsChart.data.datasets[0].data = historicalSRS.data;
            srsChart.update();

            radarChart.data.datasets[0].data = [
                (displayData.temp - 30) * 5, 
                displayData.pm / 2,          
                Math.random() * 40,          
                (displayData.co2 - 400) / 20,
                displayData.srs / 1.5        
            ];
            radarChart.update();

            renderRoster();
        }

        function renderRoster() {
            rosterBody.innerHTML = '';
            liveData.forEach(s => {
                let statusColor = s.srs > 70 ? 'bg-red-100 text-red-900' : (s.srs > 40 ? 'bg-yellow-100 text-yellow-900' : 'bg-green-100 text-green-900');
                let dotColor = s.srs > 70 ? 'bg-red-500' : (s.srs > 40 ? 'bg-yellow-500' : 'bg-green-500');
                
                let isSelected = selectedSoldierId === s.id;
                let rowClass = isSelected ? "bg-blue-50 border-l-4 border-blue-500" : "hover:bg-gray-100";

                let tr = document.createElement('tr');
                tr.className = `cursor-pointer transition border-b border-gray-200 ${rowClass}`;
                tr.onclick = () => selectSoldier(s.id);
                
                tr.innerHTML = `
                    <td class="px-5 py-2 text-sm">
                        <div class="flex items-center">
                            <div class="ml-3">
                                <p class="text-gray-900 whitespace-no-wrap font-bold">${s.id}</p>
                                <p class="text-gray-600 whitespace-no-wrap text-xs">${s.name}</p>
                            </div>
                        </div>
                    </td>
                    <td class="px-5 py-2 text-sm">
                        <span class="relative inline-block px-3 py-1 font-semibold leading-tight rounded-full ${statusColor}">
                            <span aria-hidden class="absolute inset-0 opacity-50 rounded-full"></span>
                            <span class="relative text-xs">${s.srs > 70 ? 'DANGER' : 'Active'}</span>
                        </span>
                    </td>
                    <td class="px-5 py-2 text-sm text-gray-700">${s.activity}</td>
                    <td class="px-5 py-2 text-sm text-gray-700">${s.pm}</td>
                    <td class="px-5 py-2 text-sm text-gray-700">${s.co2}</td>
                    <td class="px-5 py-2 text-sm text-gray-700">${s.temp}¬∞C</td>
                    <td class="px-5 py-2 text-sm text-right font-bold">
                        <span class="status-dot ${dotColor} mr-2"></span>${s.srs}
                    </td>
                `;
                rosterBody.appendChild(tr);
            });
        }

        function selectSoldier(id) {
            if (selectedSoldierId === id) {
                selectedSoldierId = null; 
            } else {
                selectedSoldierId = id;
            }
            let totalSRS = liveData.reduce((a,b)=>a+b.srs,0);
            let totalTemp = liveData.reduce((a,b)=>a+parseFloat(b.temp),0);
            updateDashboard(
                liveData.filter(s=>s.srs>60).length, 
                totalSRS / liveData.length, 
                totalTemp / liveData.length
            );
        }

        // Arch Detail Logic
        const archDetails = {
            'sensors': "<strong>Input:</strong> Wearable sensors (measuring PM2.5, VOC, CO2, Humidity) + Satellite API (Terrain tiles, Heat Index).<br><strong>Goal:</strong> Gather hyper-local and macro-environmental data.",
            'fusion': "<strong>Processing:</strong> The Mobile App acts as an Edge node. It merges the GPS location with satellite maps and syncs it with the sensor readings via Bluetooth.",
            'ai': "<strong>Analysis:</strong> The Python-based AI model evaluates the fused data against historical health baselines. It calculates the SRS (Soldier Risk Score) considering activity load (Run vs Rest).",
            'alert': "<strong>Output:</strong> Immediate push notifications to the soldier (Haptic/HUD) and the Command Dashboard. High SRS (>75) triggers an automatic Evac protocol."
        };

        function showArchDetail(key) {
            const box = document.getElementById('arch-detail-box');
            const title = document.getElementById('detail-title');
            const content = document.getElementById('detail-content');
            
            box.classList.remove('hidden');
            
            const titles = {
                'sensors': 'Step 1: Data Collection',
                'fusion': 'Step 2: Edge Processing',
                'ai': 'Step 3: AI Prediction Module',
                'alert': 'Step 4: Action & Alerting'
            };

            title.innerText = titles[key];
            content.innerHTML = archDetails[key];
        }

        // Toggle Simulation
        toggleBtn.addEventListener('click', () => {
            if (isSimulating) {
                clearInterval(simInterval);
                simIcon.innerText = "‚ñ∂Ô∏è";
                simText.innerText = "RESUME SIMULATION";
                isSimulating = false;
                debriefBtn.disabled = historicalSRS.data.length === 0;
                toggleBtn.classList.remove('bg-red-700', 'hover:bg-red-800');
                toggleBtn.classList.add('bg-green-700', 'hover:bg-green-800');
            } else {
                if (historicalSRS.data.length === 0) {
                    // Reset on first run only
                    timeStep = 0;
                    historicalSRS = { labels: [], data: [] };
                }
                simInterval = setInterval(generateDataStep, 1500); 
                simIcon.innerText = "‚è∏Ô∏è";
                simText.innerText = "PAUSE SIMULATION";
                isSimulating = true;
                debriefBtn.disabled = true;
                toggleBtn.classList.remove('bg-green-700', 'hover:bg-green-800');
                toggleBtn.classList.add('bg-red-700', 'hover:bg-red-800');
            }
        });
        
        // Debrief Button Listener
        debriefBtn.addEventListener('click', generateDebriefReport);

        // Init Roster empty state
        renderRoster();
        // Nav Toggle
        document.getElementById('nav-toggle').onclick = function(){
            document.getElementById("nav-content").classList.toggle("hidden");
        }
        
    </script>
</body>
</html>
